{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>üìä –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>

  <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ (4 —É —Ä—è–¥–∫—É —è–∫ —î) -->
  <div class="row mt-3">
    <div class="col-md-3"><div class="card text-center shadow-sm"><div class="card-body">
      <h5 class="card-title">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</h5><p class="fs-4">{{ total_users }}</p>
    </div></div></div>
    <div class="col-md-3"><div class="card text-center shadow-sm"><div class="card-body">
      <h5 class="card-title">–¢–æ–≤–∞—Ä–∏</h5><p class="fs-4">{{ total_products }}</p>
    </div></div></div>
    <div class="col-md-3"><div class="card text-center shadow-sm"><div class="card-body">
      <h5 class="card-title">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</h5><p class="fs-4">{{ total_orders }}</p>
    </div></div></div>
    <div class="col-md-3"><div class="card text-center shadow-sm"><div class="card-body">
      <h5 class="card-title">–î–æ—Ö—ñ–¥</h5><p class="fs-4">{{ total_revenue }} ‚Ç¥</p>
    </div></div></div>
  </div>

  <!-- –£—Å—ñ —Å–µ–∫—Ü—ñ—ó –ø–æ 2 –≤ —Ä—è–¥–∫—É -->
  <div class="row mt-4">
    <div class="col-md-6">
      <h4>üî• –¢–æ–ø –±—Ä–µ–Ω–¥–∏</h4>
      <ul class="list-group">
        {% for b in top_brands %}
          <li class="list-group-item d-flex justify-content-between">
            {{ b.brand }} <span class="badge bg-primary">{{ b.cnt }}</span>
          </li>
        {% endfor %}
      </ul>
    </div>
    <div class="col-md-6">
      <h4>üì± –¢–æ–ø —Ç–æ–≤–∞—Ä–∏</h4>
      <ul class="list-group">
        {% for p in top_products %}
          <li class="list-group-item d-flex justify-content-between">
            {{ p.title }} <span class="badge bg-success">{{ p.sold }}</span>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-md-6">
      <h4>üîç –¢–æ–ø –ø–æ—à—É–∫–∏</h4>
      <ul class="list-group">
        {% for s, cnt in top_searches %}
          <li class="list-group-item d-flex justify-content-between">
            {{ s }} <span class="badge bg-info">{{ cnt }}</span>
          </li>
        {% endfor %}
      </ul>
    </div>
    <div class="col-md-6">
      <h4>‚öôÔ∏è –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏</h4>
      <canvas id="filtersChart" height="300"></canvas>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-md-6">
      <h4>üì¶ –ü—Ä–æ–¥–∞–Ω—ñ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∏</h4>
      <canvas id="soldChart" height="300"></canvas>
    </div>
    <div class="col-md-6">
      <h4>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π</h4>
      <canvas id="recStatsChart" height="300"></canvas>
      <p class="mt-2 text-muted">
        –†—ñ–≤–µ–Ω—å –∑–∞–ª—É—á–µ–Ω–æ—Å—Ç—ñ: <b>{{ rec_stats.user_engagement_rate }}%</b><br>
        –ö–æ–Ω–≤–µ—Ä—Å—ñ—è –ø–æ–∫—É–ø–æ–∫: <b>{{ rec_stats.purchase_conversion }}%</b>
      </p>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-md-12">
      <h4>üìÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø–æ –¥–∞—Ç–∞—Ö</h4>
      <canvas id="ordersChart" height="300"></canvas>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // –§—ñ–ª—å—Ç—Ä–∏
  new Chart(document.getElementById('filtersChart'), {
    type: 'bar',
    data: {
      labels: [{% for f,cnt in filter_counts.items() %}'{{ f }}',{% endfor %}],
      datasets: [{
        label: '–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è',
        data: [{% for f,cnt in filter_counts.items() %}{{ cnt }},{% endfor %}],
        backgroundColor: 'rgba(255, 193, 7, 0.7)',
        borderColor: 'rgba(255, 193, 7, 1)',
        borderWidth: 1
      }]
    },
    options: { indexAxis: 'y', responsive: true, plugins:{legend:{display:false}}, scales:{x:{beginAtZero:true}} }
  });

  // –ü—Ä–æ–¥–∞–Ω—ñ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∏
  new Chart(document.getElementById('soldChart'), {
    type: 'bar',
    data: {
      labels: [{% for p in sold_products %}'{{ p.title }}',{% endfor %}],
      datasets: [{
        label: '–ü—Ä–æ–¥–∞–Ω–æ —à—Ç.',
        data: [{% for p in sold_products %}{{ p.sold }},{% endfor %}],
        backgroundColor: 'rgba(40, 167, 69, 0.7)',
        borderColor: 'rgba(40, 167, 69, 1)',
        borderWidth: 1
      }]
    },
    options: { indexAxis: 'y', responsive: true, plugins:{legend:{display:false}}, scales:{x:{beginAtZero:true}} }
  });

  // üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π
  new Chart(document.getElementById('recStatsChart'), {
    type: 'bar',
    data: {
      labels: ['–ö–ª—ñ–∫–∏','–ü–æ–∫—É–ø–∫–∏','–£ –±–∞–∂–∞–Ω–æ–º—É','–£ –∫–æ—à–∏–∫'],
      datasets: [{
        label: '–í–∑–∞—î–º–æ–¥—ñ—ó',
        data: [{{ rec_stats.clicked }}, {{ rec_stats.purchased }}, {{ rec_stats.wishlisted }}, {{ rec_stats.cart_adds }}],
        backgroundColor: ['#0d6efd','#198754','#dc3545','#ffc107']
      }]
    },
    options: { 
      responsive: true, 
      plugins:{legend:{display:false}},
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤–∑–∞—î–º–æ–¥—ñ–π'
          }
        }
      }
    }
  });

  // üìÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø–æ –¥–∞—Ç–∞—Ö
  new Chart(document.getElementById('ordersChart'), {
    type: 'line',
    data: {
      labels: [{% for o in orders_by_date %}'{{ o.date }}',{% endfor %}],
      datasets: [
        {
          label: '–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è',
          data: [{% for o in orders_by_date %}{{ o.orders }},{% endfor %}],
          borderColor: '#0d6efd',
          backgroundColor: 'rgba(13,110,253,0.3)',
          tension: 0.3
        },
        {
          label: '–î–æ—Ö—ñ–¥ ‚Ç¥',
          data: [{% for o in orders_by_date %}{{ o.revenue|default(0) }},{% endfor %}],
          borderColor: '#198754',
          backgroundColor: 'rgba(25,135,84,0.3)',
          tension: 0.3,
          yAxisID: 'y1'
        }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      stacked: false,
      // maintainAspectRatio: false, // –¥–æ–∑–≤–æ–ª—è—î –∫–∞—Å—Ç–æ–º–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏
      aspectRatio: 4, // –±—ñ–ª—å—à–µ –∑–Ω–∞—á–µ–Ω–Ω—è = –Ω–∏–∂—á–∏–π –≥—Ä–∞—Ñ—ñ–∫
      scales: {
        y: { beginAtZero: true, title:{display:true,text:'–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è'} },
        y1: { beginAtZero: true, position:'right', title:{display:true,text:'–î–æ—Ö—ñ–¥ ‚Ç¥'}, grid:{drawOnChartArea:false} }
      }
    }
  });
</script>
{% endblock %}
